#!/bin/bash
set -euo pipefail

# Install OpenCode CLI for Kimi K2.5 benchmarks via OpenRouter

# Check if opencode is already installed (pre-baked in Docker image)
if command -v opencode &>/dev/null; then
    echo "OpenCode already installed: $(opencode --version 2>/dev/null || echo 'unknown')"
    exit 0
fi

apt-get update
apt-get install -y curl

curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.2/install.sh | bash

export NVM_DIR="$HOME/.nvm"
# Source nvm with || true to handle nvm.sh's internal non-zero returns
\. "$NVM_DIR/nvm.sh" || true
# Verify NVM loaded successfully
command -v nvm &>/dev/null || { echo "Error: NVM failed to load" >&2; exit 1; }

nvm install 22
npm -v

{% if version %}
npm i -g opencode-ai@{{ version }}
{% else %}
npm i -g opencode-ai@latest
{% endif %}
